<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Psychiatric Session Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body{
            background:#0f0f0f;
            color:#e5e7eb;
            font-family:'Segoe UI', Tahoma, sans-serif;
            padding:25px;
        }

        .container{
            max-width:1100px;
            margin:auto;
            background:#1a1a1a;
            padding:30px;
            border-radius:8px;
            border:1px solid #2b2b2b;
        }

        h1{
            text-align:center;
            margin-bottom:25px;
            color:#ffffff;
        }

        h3{
            margin-top:30px;
            color:#ffffff;
        }

        .cards{
            display:flex;
            flex-wrap:wrap;
            gap:15px;
            justify-content:center;
            margin-bottom:20px;
        }

        .card{
            background:#111827;
            border:1px solid #1f2937;
            border-radius:8px;
            padding:16px 20px;
            min-width:220px;
            text-align:center;
        }

        .label{
            font-size:14px;
            color:#9ca3af;
        }

        .value{
            font-size:22px;
            font-weight:700;
            color:#60a5fa;
            margin-top:8px;
        }

        .notice{
            background:#0d0d0d;
            border:1px solid #2d2d2d;
            padding:14px;
            border-radius:6px;
            margin-top:18px;
            font-size:14px;
            line-height:1.5;
            color:#d1d5db;
        }

        table{
            width:100%;
            border-collapse:collapse;
            margin-top:15px;
            font-size:14px;
        }

        th, td{
            padding:10px 12px;
            border-bottom:1px solid #2d2d2d;
            text-align:left;
        }

        th{
            color:#93c5fd;
            background:#0d0d0d;
        }

        canvas{
            width:100%!important;
            height:320px!important;
            background:#0d0d0d;
            padding:10px;
            border-radius:6px;
            border:1px solid #272727;
            margin-top:15px;
        }

        .back-btn{
            display:inline-block;
            margin-top:25px;
            background:#2563eb;
            padding:10px 18px;
            border-radius:6px;
            color:white;
            text-decoration:none;
            font-weight:600;
        }

        .back-btn:hover{
            background:#1d4ed8;
        }
    </style>
</head>

<body>

<div class="container">

<h1>üß† Psychiatric Session Report</h1>

<div class="notice">
<b>Patient ID:</b> {{ patient_id }}
</div>

<!-- SUMMARY CARDS -->
<div class="cards">
    <div class="card">
        <div class="label">Dominant Emotion</div>
        <div class="value">{{ prediction_text }}</div>
    </div>

    <div class="card">
        <div class="label">Average Confidence</div>
        <div class="value">{{ prediction_conf }}</div>
    </div>

    <div class="card">
        <div class="label">Emotional Instability</div>
        <div class="value">{{ instability }}</div>
    </div>
</div>

<!-- SPEECH BIOMARKERS -->
<h3>üó£Ô∏è Speech Biomarkers</h3>
<table>
    <tr>
        <th>Metric</th>
        <th>Value</th>
        <th>Clinical Interpretation</th>
    </tr>
    <tr>
        <td>Speech Rate</td>
        <td>{{ speech.speech_rate }}</td>
        <td>Slow ‚Üí Depression | Fast ‚Üí Anxiety / Mania</td>
    </tr>
    <tr>
        <td>Silence Ratio</td>
        <td>{{ speech.silence_ratio }}</td>
        <td>High ‚Üí Withdrawal / Low engagement</td>
    </tr>
    <tr>
        <td>RMS Energy</td>
        <td>{{ speech.rms_energy }}</td>
        <td>Low ‚Üí Flat affect</td>
    </tr>
    <tr>
        <td>Pitch Variability</td>
        <td>{{ speech.pitch_variability }}</td>
        <td>Low ‚Üí Emotional blunting</td>
    </tr>
</table>

<!-- RISK FLAGS -->
{% if risks %}
<div class="notice">
<b>‚ö† Observed Behavioral Risk Indicators</b>
<ul>
{% for r in risks %}
    <li>{{ r }}</li>
{% endfor %}
</ul>
</div>
{% endif %}

<!-- EMOTION TIMELINE GRAPH -->
<h3>üìä Emotion Confidence Timeline</h3>
<canvas id="timelineChart"></canvas>

<!-- TREND -->
<h3>üìà Longitudinal Trend</h3>
<div class="notice">
{{ trend }}
</div>


<h3>üßæ Clinical Session Summary (AI-Generated)</h3>
<div class="notice" style="white-space:pre-line;">
{{ clinical_summary }}
</div>

<!-- PATIENT HISTORY -->
<h3>üìÖ Patient Session History (Last 5 Sessions)</h3>

{% if history %}
<table>
    <tr>
        <th>Date</th>
        <th>Emotion</th>
        <th>Confidence</th>
        <th>Instability</th>
    </tr>
    {% for h in history %}
    <tr>
        <td>{{ h.date }}</td>
        <td>{{ h.emotion }}</td>
        <td>{{ h.confidence }}</td>
        <td>{{ h.instability }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<div class="notice">No previous sessions found for this patient.</div>
{% endif %}

<div class="notice">
<b>Disclaimer:</b> This system provides behavioral indicators only and does not diagnose mental illness.
</div>

<a href="/" class="back-btn">‚¨Ö Back to Upload</a>

</div>

<!-- CHART SCRIPT -->
<script>
const timeline = {{ emotion_timeline | tojson | safe }};

if (timeline && timeline.length > 0) {
    const labels = timeline.map(t => `${t.start}-${t.end}s`);
    const confidences = timeline.map(t => t.confidence);

    const ctx = document.getElementById("timelineChart").getContext("2d");

    new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                data: confidences,
                borderColor: "#60a5fa",
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    min: 0,
                    max: 1
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}
</script>

</body>
</html>
