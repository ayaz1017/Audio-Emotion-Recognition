<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Psychiatric Voice Analysis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #0f0f0f;
            color: #e5e7eb;
        }

        header {
            background: #181818;
            padding: 18px 30px;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 1px solid #303030;
        }

        .container {
            max-width: 1000px;
            margin: 35px auto;
            background: #1a1a1a;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #2b2b2b;
        }

        h2, h3 {
            color: #ffffff;
        }

        label {
            font-size: 14px;
            color: #9ca3af;
            display: block;
            margin-bottom: 6px;
        }

        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #2d2d2d;
            background: #0d0d0d;
            color: #e5e7eb;
            margin-bottom: 15px;
        }

        .btn {
            background: #2563eb;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            font-size: 15px;
            margin-right: 10px;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .emotion-display {
            padding: 12px;
            margin-top: 15px;
            background: #111827;
            border-radius: 6px;
            border: 1px solid #1f2937;
            color: #93c5fd;
            font-size: 16px;
        }

        canvas {
            margin-top: 25px;
            width: 100%;
            height: 320px;
            border-radius: 6px;
            background: #0d0d0d;
            padding: 10px;
            border: 1px solid #272727;
        }

        .upload-box {
            background: #111111;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #2d2d2d;
            margin-top: 35px;
        }

        .note {
            margin-top: 20px;
            font-size: 13px;
            color: #9ca3af;
        }
    </style>
</head>

<body>

<header>ðŸ§  Psychiatric Voice Analysis System</header>

<div class="container">

    <h3>Patient Information</h3>
    <label for="patient_id">Patient ID</label>
    <input type="text" id="patient_id" placeholder="e.g. P001" required>

    <h2>Live Voice Capture (Clinical Session)</h2>

    <button class="btn" onclick="beginRec()">Start Recording</button>
    <button class="btn" onclick="haltRec()">Stop & Analyze</button>

    <div class="emotion-display" id="emotionText">
        Awaiting recordingâ€¦
    </div>

    <canvas id="emotionChart"></canvas>

    <div class="upload-box">
        <h3>OR Upload Audio (Optional)</h3>

        <form action="/predict_upload" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="patient_id" id="upload_patient_id">

            <label>Audio File (.wav / .mp3)</label>
            <input type="file" name="file" accept=".wav,.mp3" required>

            <input type="submit" class="btn" value="Analyze Uploaded Audio">
        </form>
    </div>

    <div class="note">
        â€¢ Live recording automatically generates a full psychiatric report.<br>
        â€¢ Emotion inference is performed after recording ends.<br>
        â€¢ No diagnosis is provided.
    </div>

</div>

<script>
    // ----------------------------
    // GRAPH SETUP
    // ----------------------------
    const ctx = document.getElementById("emotionChart").getContext("2d");

    let chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: [{
                label: "Voice Amplitude",
                data: [],
                borderColor: "#60a5fa",
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            animation: false,
            scales: {
                y: { min: -1, max: 1 }
            }
        }
    });

    // ----------------------------
    // AUDIO VARIABLES
    // ----------------------------
    let audioCtx, analyserNode, micSrc, floatData, animLoop;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    // ----------------------------
    // START RECORDING
    // ----------------------------
    async function beginRec() {
        const patientId = document.getElementById("patient_id").value;

        if (!patientId) {
            alert("Please enter Patient ID before recording.");
            return;
        }

        document.getElementById("upload_patient_id").value = patientId;
        document.getElementById("emotionText").innerText = "Recording in progressâ€¦";

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        audioCtx = new AudioContext();
        analyserNode = audioCtx.createAnalyser();
        micSrc = audioCtx.createMediaStreamSource(stream);
        micSrc.connect(analyserNode);

        analyserNode.fftSize = 256;
        floatData = new Float32Array(analyserNode.fftSize);

        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.start();

        isRecording = true;
        drawWaveform();
    }

    // ----------------------------
    // DRAW WAVEFORM
    // ----------------------------
    function drawWaveform() {
        if (!isRecording) return;

        analyserNode.getFloatTimeDomainData(floatData);

        let avg = floatData.reduce((a, b) => a + b, 0) / floatData.length;

        chart.data.labels.push("");
        chart.data.datasets[0].data.push(avg);

        if (chart.data.labels.length > 150) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
        }

        chart.update();
        animLoop = requestAnimationFrame(drawWaveform);
    }

    // ----------------------------
    // STOP & ANALYZE
    // ----------------------------
    function haltRec() {
        if (!mediaRecorder) return;

        isRecording = false;
        cancelAnimationFrame(animLoop);
        mediaRecorder.stop();

        document.getElementById("emotionText").innerText =
            "Analyzing sessionâ€¦ Please wait.";

        mediaRecorder.onstop = async () => {
            const patientId = document.getElementById("patient_id").value;

            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            const formData = new FormData();

            formData.append("patient_id", patientId);
            formData.append("file", audioBlob, "recorded_session.wav");

            const response = await fetch("/predict_upload", {
                method: "POST",
                body: formData
            });

            if (response.redirected) {
                window.location.href = response.url;
            } else {
                alert(await response.text());
            }
        };
    }
</script>

</body>
</html>
