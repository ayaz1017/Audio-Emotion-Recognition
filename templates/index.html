<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Psychiatric Voice Analysis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-900 text-gray-200 min-h-screen">

<header class="bg-gray-800 border-b border-gray-700 px-6 py-4 text-xl font-semibold">
    ðŸ§  Psychiatric Voice Analysis System
</header>

<div class="max-w-5xl mx-auto px-6 py-8">

    <!-- PATIENT ID -->
    <div class="mb-8">
        <label class="block text-sm text-gray-400 mb-1">Patient ID</label>
        <input
            type="text"
            id="patient_id"
            placeholder="e.g. P001"
            class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-600"
        >
    </div>

    <!-- LIVE RECORDING -->
    <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 mb-10">
        <h2 class="text-xl font-semibold mb-4">
            ðŸŽ™ Live Voice Capture (Clinical Session)
        </h2>

        <div class="flex gap-4 mb-4">
            <button onclick="beginRec()"
                class="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded-lg font-semibold">
                Start Recording
            </button>

            <button onclick="haltRec()"
                class="bg-red-600 hover:bg-red-700 px-5 py-2 rounded-lg font-semibold">
                Stop & Analyze
            </button>
        </div>

        <div id="emotionText"
            class="bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-sm text-blue-300 mb-4">
            Awaiting recordingâ€¦
        </div>

        <canvas id="emotionChart" class="w-full h-72"></canvas>
    </div>

    <!-- UPLOAD AUDIO -->
    <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 mb-10">
        <h2 class="text-xl font-semibold mb-4">
            â¬† Upload Audio (Optional)
        </h2>

        <form action="/predict_upload" method="POST" enctype="multipart/form-data" id="uploadForm">
            <input type="hidden" name="patient_id" id="upload_patient_id">

            <label class="block text-sm text-gray-400 mb-1">
                Audio File (.wav / .mp3)
            </label>

            <input type="file" name="file" accept=".wav,.mp3" required
                class="block w-full mb-4 text-sm">

            <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold">
                Analyze Uploaded Audio
            </button>
        </form>
    </div>

    <p class="text-sm text-gray-400">
        â€¢ Live recording automatically generates a full psychiatric report.<br>
        â€¢ Emotion inference is performed after recording completes.<br>
        â€¢ This system is for research and educational use only.
    </p>

</div>

<script>
    /* ==============================
       WAVEFORM GRAPH
    ============================== */
    const ctx = document.getElementById("emotionChart").getContext("2d");

    const chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: [{
                label: "Voice Amplitude",
                data: [],
                borderColor: "#60a5fa",
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            animation: false,
            plugins: { legend: { display: false } },
            scales: { y: { min: -1, max: 1 } }
        }
    });

    /* ==============================
       AUDIO VARIABLES
    ============================== */
    let audioCtx, analyserNode, micSrc, floatData, animLoop;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    /* ==============================
       START RECORDING
    ============================== */
    async function beginRec() {
        const pid = document.getElementById("patient_id").value;
        if (!pid) {
            alert("Please enter Patient ID before recording.");
            return;
        }

        document.getElementById("emotionText").innerText =
            "Recording in progressâ€¦";

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        audioCtx = new AudioContext();
        analyserNode = audioCtx.createAnalyser();
        micSrc = audioCtx.createMediaStreamSource(stream);
        micSrc.connect(analyserNode);

        analyserNode.fftSize = 256;
        floatData = new Float32Array(analyserNode.fftSize);

        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.start();

        isRecording = true;
        drawWave();
    }

    function drawWave() {
        if (!isRecording) return;

        analyserNode.getFloatTimeDomainData(floatData);
        const avg = floatData.reduce((a, b) => a + b, 0) / floatData.length;

        chart.data.labels.push("");
        chart.data.datasets[0].data.push(avg);

        if (chart.data.labels.length > 150) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
        }

        chart.update();
        animLoop = requestAnimationFrame(drawWave);
    }

    /* ==============================
       STOP & SEND FOR ANALYSIS
    ============================== */
    function haltRec() {
        if (!mediaRecorder) return;

        isRecording = false;
        cancelAnimationFrame(animLoop);
        mediaRecorder.stop();

        document.getElementById("emotionText").innerText =
            "Analyzing sessionâ€¦ Please wait.";

        mediaRecorder.onstop = async () => {
            const pid = document.getElementById("patient_id").value;

            const blob = new Blob(audioChunks, { type: "audio/wav" });
            const formData = new FormData();

            formData.append("patient_id", pid);
            formData.append("file", blob, "recorded_session.wav");

            const res = await fetch("/predict_upload", {
                method: "POST",
                body: formData
            });

            if (res.redirected) {
                window.location.href = res.url;
            } else {
                alert(await res.text());
            }
        };
    }

    /* ==============================
       UPLOAD FORM FIX (PATIENT ID)
    ============================== */
    document.getElementById("uploadForm")
        .addEventListener("submit", function (e) {

            const pid = document.getElementById("patient_id").value;
            if (!pid) {
                alert("Please enter Patient ID before uploading audio.");
                e.preventDefault();
                return;
            }

            document.getElementById("upload_patient_id").value = pid;
        });
</script>

</body>
</html>

